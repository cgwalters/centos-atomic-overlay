#!/bin/bash
set -xeuo pipefail

origdir=$1
buildscriptsdir=../sig-atomic-buildscripts

if ! test -L overlay.yml; then
    ln -s ${overlaydir}/overlay.yml .
fi
if ! test -d src; then
    rpmdistro-gitoverlay init
fi    

# Create this now so it always exists for Jenkins
mkdir -p ${origdir}/build-logs

# Git fetch all the things
rpmdistro-gitoverlay resolve --fetch-all --touch-if-changed fetch.stamp
if ! test -f fetch.stamp; then
    exit 0
fi

# Do a build if something changed
build_success=false
if rpmdistro-gitoverlay build --touch-if-changed build.stamp --logdir=${origdir}/build-logs; then
    build_success=true
fi

if ! test -d ostree/repo/objects; then
    mkdir -p ostree/repo
    ostree --repo=ostree/repo init --mode=archive-z2
fi

treefile=centos-atomic-host-continuous.json
sed -i -e 's,^baseurl=.*,baseurl=file://'$(pwd)/build',' ${buildscriptsdir}/atomic-centos-continuous.repo
sudo rpm-ostree compose tree --touch-if-changed=$(pwd)/treecompose.stamp --repo=ostree/repo ${buildscriptsdir}/${treefile}
if test -f treecompose.stamp; then
    ostree --repo=ostree/repo summary -u
    rpm-ostree db --repo=ostree/repo diff centos-atomic-host/7/x86_64/devel/continuous{^,}
    ostree --repo=ostree/repo static-delta generate centos-atomic-host/7/x86_64/devel/continuous
    ostree --repo=ostree/repo prune --keep-younger-than='30 days ago'
    ostree --repo=ostree/repo summary -u
fi
sudo chown -R -h $USER:$USER ostree/repo
